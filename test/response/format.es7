'use strict'

const test    = require('tap'),
      helpers = require('../helpers'),
      end     = helpers.end,
      create  = helpers.create,
      request = helpers.request

test.test('.format() should throw', test => {
    const app = create().use(ctx => {
        test.throws(() => {
            ctx.res.format()
        })

        ctx.send('ok')
    })

    request(app)
        .get('/')
        .expect(200, 'ok', end(test))
})

test.test('req.accepts() /w switch statement should work with classic middleware', test => {
    const app  = create(),
          done = end(test, 3)

    app.use(ctx => {
        const res = ctx.res

        switch (ctx.accepts('text', 'json')) {
            case 'text':
                res.type('text')
                res.send('text')
                break

            case 'json':
                res.json({ ok: true })
                break

            default:
                res.status(406).send('Not Acceptable')
        }
    })

    request(app)
        .get('/')
        .set('accept', 'text/plain')
        .expect('content-type', 'text/plain; charset=utf-8')
        .expect(200, 'text', done)

    request(app)
        .get('/')
        .set('accept', 'application/json')
        .expect('content-type', 'application/json; charset=utf-8')
        .expect(200, '{"ok":true}', done)

    request(app)
        .get('/')
        .set('accept', 'application/xml')
        .expect(406, 'Not Acceptable', done)
})

test.test('req.accepts() /w switch statement should work with async middleware', test => {
    const app  = create(),
          done = end(test, 3)

    app.use(async ctx => {
        switch (ctx.accepts('text', 'json')) {
            case 'text':
                ctx.type = 'text'
                ctx.body = 'text'
                break

            case 'json':
                ctx.body = { ok: true }
                break

            default:
                ctx.throw(406)
        }

        ctx.send()
    })

    request(app)
        .get('/')
        .set('accept', 'text/plain')
        .expect('content-type', 'text/plain; charset=utf-8')
        .expect(200, 'text', done)

    request(app)
        .get('/')
        .set('accept', 'application/json')
        .expect('content-type', 'application/json; charset=utf-8')
        .expect(200, '{"ok":true}', done)

    request(app)
        .get('/')
        .set('accept', 'application/xml')
        .expect(406, 'Not Acceptable', done)
})
